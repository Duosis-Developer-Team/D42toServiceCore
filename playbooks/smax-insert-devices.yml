# send-to-smax.yaml
---
- name: Insert Device42 devices into SMAX
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Fetch devices from Device42
      uri:
        url: "{{ device42_api_url }}"
        method: GET
        headers:
          Authorization: "{{ device42_auth_header }}"
        return_content: yes
        status_code: 200
        validate_certs: no
      register: device42_response
      when: device42_api_url is defined and device42_auth_header is defined

    - name: Fail if Device42 variables are not provided
      fail:
        msg: "device42_api_url and device42_auth_header must be provided in AWX Extra Vars"
      when: device42_api_url is not defined or device42_auth_header is not defined

    - name: Extract device list
      set_fact:
        devices: "{{ device42_response.json.Devices | default(device42_response.json.devices) }}"
      when: device42_response is defined

    - name: Process device data and add IP information
      set_fact:
        processed_devices: "{{ devices | map('combine', {'processed_ips': item.ip_addresses | default([]) + [item.ip_address | default('')] + [item.primary_ip | default('')] | select('string') | list | unique}) }}"
      when: devices is defined

    - name: Show sample processed device data
      debug:
        var: processed_devices[0:3]
      when: processed_devices is defined

    - name: Get SMAX token
      uri:
        url: "{{ smax_token_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body: "{{ { 'Login': smax_user, 'Password': smax_pass } | to_json }}"
        return_content: yes
        status_code: 200
        validate_certs: no
      register: smax_token_response
      when: smax_token_url is defined and smax_user is defined and smax_pass is defined

    - name: Extract token
      set_fact:
        smax_token: "{{ smax_token_response.content }}"
      when: smax_token_response is defined and smax_token_response.content is defined
      register: token_extraction_result
      ignore_errors: yes

    - name: Fail if token extraction failed
      fail:
        msg: "Failed to extract token from SMAX response. Response content: {{ smax_token_response.content }}"
      when: token_extraction_result is failed

    - name: Prepare SMAX IpAddresses string
      set_fact:
        smax_ipaddresses: >-
          {{ {'IpAddress': item.ip_addresses | default([]) | map('community.general.json_query', '{
            IpValue: ip || ``,
            IpType: type || ``,
            AuthoritativeDNSName: dns_name || ``,
            RoutingDomain: routing_domain || ``,
            GlobalId: global_id || ``,
            Keep: keep || ``,
            Id: id || ``
          }') | list } | to_json }}
      loop: "{{ devices }}"
      loop_control:
        loop_var: item
        index_var: idx
        label: "ipaddresses_{{ idx }}"
      register: smax_ipaddresses_list

    - name: Prepare SMAX Cpus string
      set_fact:
        smax_cpus: >-
          {{ {'Cpu': [ {
            'CpuClockSpeed': (item.cpuspeed | default('')) | string,
            'CpuCoreNumber': (item.cpucore | default('')) | string,
            'CpuType': '',
            'CpuVendor': '',
            'CpuId': '',
            'GlobalId': '',
            'Keep': '',
            'Id': ''
          } ] } | to_json }}
      loop: "{{ devices }}"
      loop_control:
        loop_var: item
        index_var: idx
        label: "cpus_{{ idx }}"
      register: smax_cpus_list

    - name: Prepare SMAX DiskDevices string
      set_fact:
        smax_diskdevices: >-
          {{ {'DiskDevice': item.hdd_details | default([]) | map('community.general.json_query', '{
            DiskName: hdd.description || ``,
            DiskSize: hdd.size || ``,
            DiskModelName: hdd.description || ``,
            DiskVendor: hdd.manufacturer_id || ``,
            DiskType: hdd.type || ``,
            GlobalId: hdd.global_id || ``,
            Keep: hdd.keep || ``,
            Id: hdd.hd_id || ``
          }') | list } | to_json }}
      loop: "{{ devices }}"
      loop_control:
        loop_var: item
        index_var: idx
        label: "diskdevices_{{ idx }}"
      register: smax_diskdevices_list

    - name: Merge processed devices with SMAX fields
      set_fact:
        processed_devices: >-
          {{ processed_devices | zip_longest(
            smax_ipaddresses_list.results | map(attribute='ansible_facts.smax_ipaddresses') | list,
            smax_cpus_list.results | map(attribute='ansible_facts.smax_cpus') | list,
            smax_diskdevices_list.results | map(attribute='ansible_facts.smax_diskdevices') | list
          ) | map('combine', ['item', {'IpAddresses': 'item1', 'Cpus': 'item2', 'DiskDevices': 'item3'}]) | list }}
      when: processed_devices is defined and smax_ipaddresses_list is defined and smax_cpus_list is defined and smax_diskdevices_list is defined

    - name: Show SMAX response summary
      debug:
        msg: "Device {{ item.item.name }} - Status: {{ item.status }} - Success: {{ item.json.meta.completion_status if item.json.meta is defined else 'Unknown' }}"
      loop: "{{ smax_responses.results }}"
      loop_control:
        index_var: rsp_idx
        label: "summary_{{ rsp_idx }}"
      when: smax_responses is defined

    - name: Show detailed SMAX response for failed devices
      debug:
        msg: |
          ===== FAILED DEVICE DETAILS =====
          Device Name: {{ item.item.name }}
          Device ID: {{ item.item.device_id | default(item.item.id) }}
          Status Code: {{ item.status }}
          Full Response: {{ item.json | to_nice_json }}
          ================================
      loop: "{{ smax_responses.results }}"
      when: 
        - smax_responses is defined
        - item.json.meta.completion_status is defined
        - item.json.meta.completion_status == "FAILED"
      loop_control:
        index_var: failed_idx
        label: "failed_device_{{ failed_idx }}"

    - name: Show payload sent for failed devices
      debug:
        msg: |
          ===== PAYLOAD SENT FOR FAILED DEVICE =====
          Device Name: {{ item.item.name }}
          Payload: {{ item.item.payload | default('No payload found') | to_nice_json }}
          =========================================
      loop: "{{ smax_responses.results }}"
      when: 
        - smax_responses is defined
        - item.json.meta.completion_status is defined
        - item.json.meta.completion_status == "FAILED"
      loop_control:
        index_var: payload_idx
        label: "payload_{{ payload_idx }}"

    - name: Show successful devices count
      debug:
        msg: "Successfully created {{ smax_responses.results | selectattr('json.meta.completion_status', 'equalto', 'OK') | list | length }} devices out of {{ smax_responses.results | length }} total devices"
      when: smax_responses is defined

    - name: Show failed devices count
      debug:
        msg: "Failed to create {{ smax_responses.results | selectattr('json.meta.completion_status', 'equalto', 'FAILED') | list | length }} devices"
      when: smax_responses is defined

    - name: Show device processing summary
      debug:
        msg: "Processed {{ processed_devices | length }} devices with IP information for SMAX integration"
      when: processed_devices is defined

    - name: Show all SMAX response headers for debugging
      debug:
        msg: |
          ===== RESPONSE HEADERS FOR DEVICE {{ item.item.name }} =====
          Headers: {{ item.headers | to_nice_json }}
          ===========================================
      loop: "{{ smax_responses.results }}"
      when: 
        - smax_responses is defined
        - item.json.meta.completion_status is defined
        - item.json.meta.completion_status == "FAILED"
      loop_control:
        index_var: header_idx
        label: "headers_{{ header_idx }}"
