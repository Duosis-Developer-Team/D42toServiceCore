---
- name: D42 ve SMAX cihazlarını karşılaştır
  hosts: localhost
  gather_facts: false

  vars:
    # D42 için
    device42_api_url: "{{ device42_api_url }}"  # AWX Extra Vars ile gelmeli
    device42_auth_header: "{{ device42_auth_header }}"  # AWX Extra Vars ile gelmeli
    # SMAX için
    smax_token_url: "{{ smax_token_url }}"  # AWX Extra Vars ile gelmeli
    smax_user: "{{ smax_user }}"  # AWX Extra Vars ile gelmeli
    smax_pass: "{{ smax_pass }}"  # AWX Extra Vars ile gelmeli
    smax_api_url: "{{ smax_api_url }}"  # AWX Extra Vars ile gelmeli
    smax_layout: "LastUpdateTime,DisplayLabel,Description,Cpus,MemorySize,RunningSoftwares,D42id_c,IpAddresses,OsName,DiskDevices,NetworkCards"
    smax_tenantid: "669866050"

  tasks:
    - name: D42 cihazlarını çek
      uri:
        url: "{{ device42_api_url }}"
        method: GET
        headers:
          Authorization: "{{ device42_auth_header }}"
        return_content: yes
        status_code: 200
        validate_certs: no
      register: d42_response

    - name: D42 cihaz listesini çıkar
      set_fact:
        d42_devices: "{{ d42_response.json.Devices | default(d42_response.json.devices) }}"

    - name: SMAX token al
      uri:
        url: "{{ smax_token_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body: "{{ { 'Login': smax_user, 'Password': smax_pass } | to_json }}"
        return_content: yes
        status_code: 200
        validate_certs: no
      register: smax_token_response

    - name: SMAX token'ı çıkar
      set_fact:
        smax_token: "{{ smax_token_response.content }}"

    - name: SMAX token response'unu göster
      debug:
        var: smax_token_response

    - name: SMAX cihazlarını çek
      uri:
        url: "{{ smax_api_url }}?layout={{ smax_layout | urlencode }}"
        method: GET
        headers:
          Cookie: "SMAX_AUTH_TOKEN={{ smax_token }}; TENANTID={{ smax_tenantid }}"
        return_content: yes
        status_code: 200
        validate_certs: no
      register: smax_response

    - name: SMAX cihaz çekme response'unu göster
      debug:
        var: smax_response

    - name: SMAX cihaz çekme response'unun json'unu göster
      debug:
        var: smax_response.json

    - name: SMAX cihaz listesini çıkar
      set_fact:
        smax_devices: "{{ smax_response.json.entities | default([]) }}"

    - name: SMAX cihazlarını Device42 formatına dönüştür
      set_fact:
        smax_devices_mapped: []

    - name: SMAX cihazlarını Device42 formatına güvenli şekilde dönüştür (her cihaz için)
      set_fact:
        smax_devices_mapped: "{{ smax_devices_mapped + [ mapped_device ] }}"
      vars:
        nc_decoded: >-
          {{ (item.properties.NetworkCards | from_json) if (item.properties.NetworkCards is defined and item.properties.NetworkCards|length > 0) else [] }}
        mapped_device:
          device_id: "{{ item.properties.D42id_c | default('') }}"
          name: "{{ item.properties.DisplayLabel | default('') }}"
          manufacturer: "{{ item.properties.Vendor | default('') }}"
          hw_model: "{{ item.properties.Model | default('') }}"
          ip_addresses: >-
            {{ (item.properties.IpAddresses | from_json) if (item.properties.IpAddresses is defined and item.properties.IpAddresses|length > 0) else [] }}
          mac_addresses: >-
            {{ nc_decoded if nc_decoded is iterable and nc_decoded is not string else [] | map(attribute='MacAddress') | list }}
          cpus: >-
            {{ (item.properties.Cpus | from_json) if (item.properties.Cpus is defined and item.properties.Cpus|length > 0) else [] }}
          hdd_details: >-
            {{ (item.properties.DiskDevices | from_json) if (item.properties.DiskDevices is defined and item.properties.DiskDevices|length > 0) else [] }}
          memory: "{{ item.properties.MemorySize | default('') }}"
          os: "{{ item.properties.OsName | default('') }}"
          last_update_time: "{{ item.properties.LastUpdateTime | default(0) }}"
      loop: "{{ smax_devices }}"

    - name: SMAX cihazlarının Device42 formatındaki halini göster
      debug:
        var: smax_devices_mapped

    - name: Device42'den gelen cihaz adlarını göster
      debug:
        msg: "{{ d42_devices | map(attribute='name') | list }}"

    - name: SMAX'ten gelen cihaz adlarını göster
      debug:
        msg: "{{ smax_devices_mapped | map(attribute='name') | list }}"

    - name: D42 ve SMAX cihazlarını isim (name) üzerinden eşleştir
      set_fact:
        d42_names: "{{ d42_devices | map(attribute='name') | select('string') | list }}"
        smax_names: "{{ smax_devices_mapped | map(attribute='name') | select('string') | list }}"

    - name: D42'de olup SMAX'de olmayan cihazları bul (Yeni Yazdırılacak Cihazlar)
      set_fact:
        yeni_yazdirilacak_cihazlar: >-
          {{ d42_devices | selectattr('name', 'defined') | selectattr('name', 'in', (d42_names | difference(smax_names))) | list }}

    - name: SMAX cihazlarını isimden dict'e çevir (last_update_time için)
      set_fact:
        smax_dict: "{{ dict(smax_devices_mapped | map(attribute='name') | zip(smax_devices_mapped)) }}"

    - name: Güncellenecek cihazları bul (LastUpdated karşılaştırmalı)
      set_fact:
        guncellenecek_cihazlar: []

    - name: LastUpdated karşılaştırması yap ve güncellenecek cihazları belirle
      set_fact:
        guncellenecek_cihazlar: >-
          {% set smax_dict = dict(smax_devices_mapped | map(attribute='name') | zip(smax_devices_mapped)) %}
          {% set common_names = d42_names | intersect(smax_names) %}
          {% set result = [] %}
          {% for d42_device in d42_devices %}
            {% if d42_device.name is defined and d42_device.name in common_names and d42_device.last_updated is defined %}
              {% set smax_device = smax_dict.get(d42_device.name) %}
              {% if smax_device and smax_device.last_update_time is defined %}
                {% if (d42_device.last_updated | int) > (smax_device.last_update_time | int) %}
                  {% set _ = result.append(d42_device) %}
                {% endif %}
              {% endif %}
            {% endif %}
          {% endfor %}
          {{ result }}

    - name: Güncellenecek cihazlarda LastUpdated bilgilerini göster
      vars:
        smax_dict: "{{ dict(smax_devices_mapped | map(attribute='name') | zip(smax_devices_mapped)) }}"
      debug:
        msg: >-
          Cihaz: {{ item.name }}
          Device42 LastUpdated: {{ item.last_updated }}
          SMAX LastUpdateTime: {{ smax_dict[item.name].last_update_time | default('YOK') }}
      loop: "{{ guncellenecek_cihazlar }}"



    - name: Sonuçları göster
      debug:
        msg: |
          Yeni Yazdırılacak Cihazlar (D42'de olup SMAX'de olmayanlar):
          {{ yeni_yazdirilacak_cihazlar | map(attribute='name') | list }}

          Güncellenecek Cihazlar (İki tarafta da olup farklı olanlar):
          {{ guncellenecek_cihazlar | map(attribute='name') | list }}
